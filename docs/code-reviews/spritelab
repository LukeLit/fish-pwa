Code Review: SpriteLab Implementation
Overall Assessment
The implementation is solid and follows the plan well. The core functionality works correctly - prompt composition uses composeFishPrompt() like the batch script, local-first storage with IndexedDB is implemented, and the upload flow successfully updates creature metadata.
Files Implemented
File	Lines	Status
components/SpriteGenerationLab.tsx	706	Good
lib/storage/sprite-lab-db.ts	210	Good
app/api/upload-growth-sprite/route.ts	160	Good
components/FishEditOverlay.tsx	Modified	Good
Issue 1: Missing Blob Sprite Loading (Medium Priority)
Location: components/SpriteGenerationLab.tsx lines 141-182
Current Behavior:
The load effect only checks IndexedDB for local sprites. If the fish already has growthSprites from blob storage, they are not displayed.
Problem:
User uploads growth sprites, closes modal, reopens - sees empty sprites
Cannot regenerate just one stage while keeping existing uploaded stages
No visual indication of what's already been uploaded
Fix Required:
Update the useEffect at line 141 to:
First load from IndexedDB (local work-in-progress has priority)
For any missing stages, fetch from fish.growthSprites blob URLs
Display combined result (local + blob fallback)
// In the loadLocalSprites async function, after IndexedDB check:// 2. Fill in missing stages from existing blob storage URLsif (fish.growthSprites) {  for (const stage of ['juvenile', 'adult', 'elder'] as GrowthStage[]) {    // Only load from blob if we don't already have a local sprite    if (!loadedSprites[stage] && fish.growthSprites[stage]?.sprite) {      try {        const response = await fetch(fish.growthSprites[stage]!.sprite);        if (response.ok) {          const blob = await response.blob();          loadedSprites[stage] = await blobToDataUrl(blob);        }      } catch (err) {        console.error(`[SpriteLab] Failed to load ${stage} from blob:`, err);      }    }  }}
Also needed:
Add fish.growthSprites to the useEffect dependency array
Consider adding a loading state while fetching blob sprites
Issue 2: sizeTier Derivation (Low Priority)
Location: components/SpriteGenerationLab.tsx line 121
Current:
sizeTier: fish.type === 'predator' ? 'predator' : fish.type === 'prey' ? 'prey' : 'mid',
Problem:
The batch script uses fish.sizeTier directly from parsed biome data. If FishData has a sizeTier field (from Creature), it should be used when available.
Fix:
sizeTier: fish.sizeTier || (fish.type === 'predator' ? 'predator' : fish.type === 'prey' ? 'prey' : 'mid'),
Note: Check if sizeTier exists on FishData interface. If not, add it:
// In FishData interfacesizeTier?: 'prey' | 'mid' | 'predator' | 'boss' | string;
Issue 3: Visual Indicator for Sprite Source (Nice-to-Have)
Location: components/SpriteGenerationLab.tsx sprite preview area
Suggestion:
Show a small badge indicating where each sprite came from:
"Local" - from IndexedDB (work in progress)
"Uploaded" - from blob storage (already in library)
Empty - not generated yet
This helps users understand the state of each growth stage.
Implementation idea:
// Add state to track sprite sourcesconst [spriteSources, setSpriteSources] = useState<Record<GrowthStage, 'local' | 'blob' | null>>({  juvenile: null,  adult: null,  elder: null,});// In the preview area, show badge:{sprites[stage] && (  <span className="absolute top-2 right-2 text-[10px] px-1.5 py-0.5 rounded bg-gray-800/80">    {spriteSources[stage] === 'local' ? 'Local' : 'Uploaded'}  </span>)}
Issue 4: Loading State for Blob Fetch (Nice-to-Have)
Location: components/SpriteGenerationLab.tsx
Suggestion:
Add a loading state while fetching existing sprites from blob storage. Currently, if the fish has large sprites, there could be a delay before they appear.
const [isLoadingExisting, setIsLoadingExisting] = useState(false);// In useEffect:setIsLoadingExisting(true);// ... fetch logic ...setIsLoadingExisting(false);// In UI:{isLoadingExisting && (  <div className="text-center text-gray-400 text-sm">Loading existing sprites...</div>)}
Summary of Changes Needed
Priority	Change	File	Lines
Medium	Load existing blob sprites when opening modal	SpriteGenerationLab.tsx	141-182
Low	Use fish.sizeTier when available	SpriteGenerationLab.tsx	121
Nice-to-have	Add sprite source badges	SpriteGenerationLab.tsx	sprite preview
Nice-to-have	Add loading state for blob fetch	SpriteGenerationLab.tsx	new state
Testing Notes
After implementing the blob loading fix:
Upload growth sprites for a fish via SpriteLab
Close the modal
Reopen SpriteLab for the same fish
Verify: All three stages should show the uploaded sprites
Regenerate one stage (e.g., elder)
Verify: juvenile + adult show uploaded versions, elder shows new generation
Upload to Library
Verify: All three updated in blob storage